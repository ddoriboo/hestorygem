<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>He'story Live - ì‹¤ì‹œê°„ AI ìŒì„± ì¸í„°ë·°</title>
    <style>
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ + ì‹¤ì‹œê°„ ì¸í„°ë·°ìš© ìŠ¤íƒ€ì¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'ë§‘ì€ ê³ ë”•', 'Malgun Gothic', sans-serif;
            font-size: 20px;
            line-height: 1.8;
            color: #2c3e50;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            margin-top: 30px;
            min-height: 80vh;
        }
        
        .live-interview {
            text-align: center;
            padding: 40px 20px;
        }
        
        .status-indicator {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            margin: 0 auto 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4em;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .status-connecting {
            background: linear-gradient(45deg, #ffc107, #ff8c00);
            animation: pulse 2s infinite;
        }
        
        .status-listening {
            background: linear-gradient(45deg, #28a745, #20c997);
            animation: listening 1.5s infinite;
        }
        
        .status-speaking {
            background: linear-gradient(45deg, #667eea, #764ba2);
            animation: speaking 0.8s infinite;
        }
        
        .status-error {
            background: linear-gradient(45deg, #dc3545, #c82333);
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.1); opacity: 1; }
        }
        
        @keyframes listening {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.02); }
            50% { transform: scale(1.05); }
            75% { transform: scale(1.02); }
        }
        
        @keyframes speaking {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.08); }
        }
        
        .volume-indicator {
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 6px;
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .volume-bar {
            height: 100%;
            background: white;
            width: 0%;
            transition: width 0.1s ease;
            border-radius: 3px;
        }
        
        .status-text {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #2c3e50;
        }
        
        .session-title {
            font-size: 1.8em;
            color: #667eea;
            margin-bottom: 30px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .controls {
            margin: 40px 0;
        }
        
        .btn {
            display: inline-block;
            padding: 18px 35px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 30px;
            font-size: 1.2em;
            font-weight: bold;
            transition: all 0.3s;
            margin: 15px 10px;
            border: none;
            cursor: pointer;
            min-width: 200px;
        }
        
        .btn:hover {
            background: #5a6fd8;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .conversation-display {
            max-height: 300px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin: 30px 0;
            text-align: left;
        }
        
        .message {
            margin: 15px 0;
            padding: 10px;
            border-radius: 10px;
        }
        
        .message-ai {
            background: #e8f4f8;
            border-left: 4px solid #667eea;
        }
        
        .message-user {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            text-align: right;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border: 1px solid #f5c6cb;
        }
        
        .live-tip {
            background: #d1ecf1;
            color: #0c5460;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="live-interview">
            <h1>ğŸ¤ ì‹¤ì‹œê°„ AI ìŒì„± ì¸í„°ë·°</h1>
            
            <div class="session-title" id="sessionTitle">
                ì„¸ì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”
            </div>
            
            <div class="status-indicator status-connecting" id="statusIndicator">
                ğŸ”„
                <div class="volume-indicator">
                    <div class="volume-bar" id="volumeBar"></div>
                </div>
            </div>
            
            <div class="status-text" id="statusText">
                ì—°ê²° ì¤€ë¹„ ì¤‘...
            </div>
            
            <div class="live-tip">
                <strong>ğŸ¯ ì‹¤ì‹œê°„ ìŒì„± ëŒ€í™” íŠ¹ì§•:</strong><br>
                â€¢ ìì—°ìŠ¤ëŸ¬ìš´ ëŒ€í™”ì²˜ëŸ¼ AIê°€ ì ì ˆí•œ íƒ€ì´ë°ì— ì‘ë‹µí•©ë‹ˆë‹¤<br>
                â€¢ ë§í•˜ëŠ” ì¤‘ê°„ì— AIê°€ ê³µê°ì´ë‚˜ ì§ˆë¬¸ì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤<br>
                â€¢ ì‹¤ì œ ì¸í„°ë·°ì–´ì™€ ëŒ€í™”í•˜ëŠ” ê²ƒì²˜ëŸ¼ í¸ì•ˆí•˜ê²Œ ì´ì•¼ê¸°í•˜ì„¸ìš”<br>
                â€¢ <strong>Google API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤</strong>
            </div>
            
            <div class="controls">
                <button class="btn" id="startBtn" onclick="startLiveInterview()">
                    ğŸ™ï¸ ì‹¤ì‹œê°„ ì¸í„°ë·° ì‹œì‘
                </button>
                <button class="btn btn-danger" id="endBtn" onclick="endLiveInterview()" disabled>
                    â¹ï¸ ì¸í„°ë·° ì¢…ë£Œ
                </button>
            </div>
            
            <div class="error-message" id="errorMessage" style="display: none;"></div>
            
            <div class="conversation-display" id="conversationDisplay" style="display: none;">
                <h3>ëŒ€í™” ë‚´ìš©</h3>
                <div id="messages"></div>
            </div>
            
            <div style="margin-top: 40px;">
                <h3>ì„¸ì…˜ ì„ íƒ</h3>
                <select id="sessionSelect" style="padding: 10px; font-size: 1.1em; margin: 10px; border-radius: 5px; width: 300px;">
                    <option value="0">í”„ë¡¤ë¡œê·¸ - ë‚˜ì˜ ë¿Œë¦¬ì™€ ì„¸ìƒì˜ ì‹œì‘</option>
                    <option value="1">Chapter 1 - ì–´ë¦° ì‹œì ˆì˜ ë³´ë¬¼ê°™ì€ ê¸°ì–µë“¤</option>
                    <option value="2">Chapter 2 - ê¿ˆì„ í‚¤ìš°ë˜ ì²­ì†Œë…„ê¸°</option>
                    <option value="3">Chapter 3 - ì²­ì¶˜ì˜ ì„ íƒê³¼ ì²« ë°œê±¸ìŒ</option>
                    <option value="4">Chapter 4 - ì‚¬ë‘ê³¼ ë§Œë‚¨ì˜ ì´ì•¼ê¸°</option>
                    <option value="5">Chapter 5 - ê°€ì •ì„ ì´ë£¨ë©°</option>
                    <option value="6">Chapter 6 - ì¼ê³¼ ì„±ì·¨ì˜ ì—¬ì •</option>
                    <option value="7">Chapter 7 - ì¸ìƒì˜ ì „í™˜ì ë“¤</option>
                    <option value="8">Chapter 8 - ì„±ìˆ™ì˜ ì‹œê°„</option>
                    <option value="9">Chapter 9 - ìƒˆë¡œìš´ ë„ì „ê³¼ ì·¨ë¯¸</option>
                    <option value="10">Chapter 10 - ì§€í˜œì™€ ì„±ì°°</option>
                    <option value="11">Epilogue - ë¯¸ë˜ë¥¼ í–¥í•œ ë©”ì‹œì§€</option>
                </select>
            </div>
        </div>
    </div>

    <script>
        let websocket = null;
        let mediaRecorder = null;
        let audioStream = null;
        let isRecording = false;
        let audioContext = null;
        let analyser = null;
        let volumeInterval = null;
        
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const sessionTitle = document.getElementById('sessionTitle');
        const startBtn = document.getElementById('startBtn');
        const endBtn = document.getElementById('endBtn');
        const errorMessage = document.getElementById('errorMessage');
        const conversationDisplay = document.getElementById('conversationDisplay');
        const messages = document.getElementById('messages');
        const sessionSelect = document.getElementById('sessionSelect');
        
        // ì„¸ì…˜ ì œëª© ì—…ë°ì´íŠ¸
        sessionSelect.addEventListener('change', function() {
            sessionTitle.textContent = this.options[this.selectedIndex].text;
        });
        
        async function startLiveInterview() {
            try {
                hideError();
                setStatus('connecting', 'ğŸ”„', 'ì‹¤ì‹œê°„ ì„¸ì…˜ ì‹œì‘ ì¤‘...');
                
                const sessionNumber = parseInt(sessionSelect.value);
                
                // ë§ˆì´í¬ ê¶Œí•œ ìš”ì²­
                audioStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        sampleRate: 16000,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: true
                    } 
                });
                
                // ìŒì„± ë¶„ì„ ì„¤ì •
                setupAudioAnalysis();
                
                // WebSocket ì—°ê²°
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/api/conversations/live/${sessionNumber}`;
                
                websocket = new WebSocket(wsUrl);
                
                websocket.onopen = function() {
                    setStatus('listening', 'ğŸ‘‚', 'AIê°€ ë“£ê³  ìˆìŠµë‹ˆë‹¤. ë§ì”€í•´ì£¼ì„¸ìš”!');
                    startBtn.disabled = true;
                    endBtn.disabled = false;
                    conversationDisplay.style.display = 'block';
                    startRecording();
                };
                
                websocket.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'audio_response') {
                        handleAIResponse(data);
                    } else if (data.type === 'error') {
                        showError('AI ì‘ë‹µ ì˜¤ë¥˜: ' + data.message);
                    }
                };
                
                websocket.onclose = function() {
                    setStatus('error', 'âŒ', 'ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤');
                    cleanup();
                };
                
                websocket.onerror = function(error) {
                    showError('WebSocket ì—°ê²° ì‹¤íŒ¨: ì‹¤ì‹œê°„ ìŒì„± ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ Google API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
                    cleanup();
                };
                
            } catch (error) {
                showError('ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤: ' + error.message);
                cleanup();
            }
        }
        
        function setupAudioAnalysis() {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const source = audioContext.createMediaStreamSource(audioStream);
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 256;
            source.connect(analyser);
            
            // ìŒëŸ‰ í‘œì‹œê¸° ì‹œì‘
            startVolumeIndicator();
        }
        
        function startVolumeIndicator() {
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            
            volumeInterval = setInterval(() => {
                if (analyser) {
                    analyser.getByteFrequencyData(dataArray);
                    const average = dataArray.reduce((a, b) => a + b) / bufferLength;
                    const volume = (average / 255) * 100;
                    document.getElementById('volumeBar').style.width = volume + '%';
                }
            }, 100);
        }
        
        function startRecording() {
            if (!audioStream) return;
            
            mediaRecorder = new MediaRecorder(audioStream, {
                mimeType: 'audio/webm;codecs=opus'
            });
            
            mediaRecorder.ondataavailable = function(event) {
                if (event.data.size > 0 && websocket && websocket.readyState === WebSocket.OPEN) {
                    // ì˜¤ë””ì˜¤ ë°ì´í„°ë¥¼ Base64ë¡œ ì¸ì½”ë”©í•´ì„œ ì „ì†¡
                    const reader = new FileReader();
                    reader.onload = function() {
                        const audioData = reader.result.split(',')[1]; // Base64 ë¶€ë¶„ë§Œ
                        websocket.send(JSON.stringify({
                            type: 'audio_chunk',
                            audio_data: audioData
                        }));
                    };
                    reader.readAsDataURL(event.data);
                }
            };
            
            mediaRecorder.start(100); // 100msë§ˆë‹¤ ë°ì´í„° ì „ì†¡
            isRecording = true;
        }
        
        function handleAIResponse(data) {
            // AI ì‘ë‹µ í‘œì‹œ
            addMessage('ai', data.text || 'AIê°€ ì‘ë‹µí–ˆìŠµë‹ˆë‹¤');
            
            // AI ìŒì„± ì¬ìƒ
            if (data.audio_data) {
                playAIAudio(data.audio_data);
            }
        }
        
        async function playAIAudio(audioData) {
            try {
                setStatus('speaking', 'ğŸ—£ï¸', 'AIê°€ ë§í•˜ê³  ìˆìŠµë‹ˆë‹¤...');
                
                // Base64 ì˜¤ë””ì˜¤ ë°ì´í„°ë¥¼ ì¬ìƒ
                const audioBlob = base64ToBlob(audioData, 'audio/wav');
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);
                
                audio.onended = function() {
                    setStatus('listening', 'ğŸ‘‚', 'AIê°€ ë“£ê³  ìˆìŠµë‹ˆë‹¤. ê³„ì† ë§ì”€í•´ì£¼ì„¸ìš”!');
                    URL.revokeObjectURL(audioUrl);
                };
                
                await audio.play();
                
            } catch (error) {
                console.error('Audio playback error:', error);
                setStatus('listening', 'ğŸ‘‚', 'AIê°€ ë“£ê³  ìˆìŠµë‹ˆë‹¤. ê³„ì† ë§ì”€í•´ì£¼ì„¸ìš”!');
            }
        }
        
        function base64ToBlob(base64, mimeType) {
            const byteCharacters = atob(base64);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            return new Blob([byteArray], { type: mimeType });
        }
        
        function addMessage(type, text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${type}`;
            messageDiv.innerHTML = `<strong>${type === 'ai' ? 'ê¸°ì–µì˜ ì•ˆë‚´ì' : 'ë‚˜'}:</strong> ${text}`;
            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
        }
        
        function endLiveInterview() {
            if (websocket) {
                websocket.close();
            }
            cleanup();
        }
        
        function cleanup() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
            }
            
            if (audioStream) {
                audioStream.getTracks().forEach(track => track.stop());
                audioStream = null;
            }
            
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            
            if (volumeInterval) {
                clearInterval(volumeInterval);
                volumeInterval = null;
            }
            
            mediaRecorder = null;
            isRecording = false;
            
            setStatus('connecting', 'ğŸ”„', 'ì—°ê²° ì¤€ë¹„ ì¤‘...');
            startBtn.disabled = false;
            endBtn.disabled = true;
        }
        
        function setStatus(statusClass, icon, text) {
            statusIndicator.className = `status-indicator status-${statusClass}`;
            statusIndicator.innerHTML = icon + '<div class="volume-indicator"><div class="volume-bar" id="volumeBar"></div></div>';
            statusText.textContent = text;
        }
        
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }
        
        function hideError() {
            errorMessage.style.display = 'none';
        }
        
        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬
        window.addEventListener('beforeunload', function() {
            cleanup();
        });
    </script>
</body>
</html>